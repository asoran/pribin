<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script type="text/javascript" src="javascript/full.js"></script>
    <title>Pribin</title>
</head>
<body onload="checkHeader()">
    <div>
        <div id="error"></div>
        <label for="text"></label>
        <textarea name="text" cols="50" rows="20" id="text" type="text"></textarea>
        <br>
        <button onclick="save()">New Message</button>
        <div id="url"></div>
    </div>

</body>

<script>
    const API_URL = '/api/v1/message/'

    async function fetchJsonGet(url) {
        return fetch(url, {method: 'GET',})
            .then(resp => resp.json());
    }

    async function fetchJsonPost(url, body) {
        return fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
        }).then(resp => resp.json());
    }

    async function save() {
        let value = document.getElementById('text').value;
        let rep = await send(value);
        
        let body = {
            msg: rep.cipherPlain,
            iv: rep.iv
        };

        let json = await fetchJsonPost(API_URL + 'new', body);
        let id = json.id;

        document.getElementById('url').innerHTML =
            `<a targer="_blank" href="/?${id}#${rep.keyPlain64}">/?${id}#${rep.keyPlain64}</a>`;
    }

    async function checkHeader() {
        const query = window.location.search.substring(1);
        const hash = window.location.hash.substring(1);

        console.log(query, hash);
        if(query == '' || hash == '') {
            ;
        } else {
            let rep = await fetchJsonGet('/api/v1/message/' + query);
            if(rep.error) {
                document.getElementById('error').innerHTML = 
                    'An error has occured: ' + rep.error;
            } else {
                console.log(rep);
                let params = {
                    name: 'AES-GCM',
                    iv: new Uint8Array(Object.values(rep.message.iv)),
                    tagLength: 128
                }

                text = await get(params, hash, rep.message.content);
                document.getElementById('text').value = text;
            }
        }

    }

</script>

</html>